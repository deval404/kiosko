<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Administrador</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #f8e8d6;
      color: #4b3b2a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    h1 {
      text-align: center;
      color: #a67c52;
      margin-bottom: 2rem;
    }

    /* Formulario */
    form {
      background: #fffaf3;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      width: 100%;
      max-width: 600px;
    }

    form input, 
    form textarea {
      width: 90%;
      padding: 0.8rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      border: 2px solid #d9a066;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s;
      background-color: white;
    }

    form input:focus, 
    form textarea:focus {
      border-color: #a67c52;
    }

    #guardar {
      background-color: #d9a066;
      color: white;
      padding: 0.9rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
      transition: background-color 0.3s, transform 0.2s;
      font-weight: 600;
      width: 100%;
    }

    #guardar:hover {
      background-color: #c68642;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    /* Tabla */
    table {
      width: 100%;
      max-width: 900px;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
      font-size: 0.95rem;
    }

    th {
      background: #a67c52;
      color: white;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background: #fffaf3;
    }

    /* Botones */
    button {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    button.editar {
      background-color: #ffc107;
      color: #4b3b2a;
    }

    button.eliminar {
      background-color: #dc3545;
      color: white;
    }
    /* ... Tus estilos existentes ... */

    /* Estilos del Modal */
    .modal {
        display: none; /* Oculto por defecto */
        position: fixed;
        z-index: 1000; /* Asegura que esté encima de todo */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 50px;
    }

    .modal-contenido {
        background-color: #fffaf3;
        margin: 5% auto; /* Centrado vertical y horizontal */
        padding: 20px;
        border: 1px solid #d9a066;
        border-radius: 12px;
        width: 80%;
        max-width: 500px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .modal-contenido h2 {
        text-align: center;
        color: #a67c52;
        margin-bottom: 1.5rem;
    }

    .modal-contenido label {
        display: block;
        margin-top: 10px;
        font-weight: 600;
        color: #4b3b2a;
    }

    .modal-botones {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .modal-botones button {
        width: 48%;
    }

  </style>
</head>
<body>

  <h1>Panel de Administración</h1>

  <div class="boton-inicio">
    <button onclick="window.location.href='Entrada.html'">Volver al Inicio</button>
  </div>

  <!-- Formulario para agregar productos -->
  <form id="formProducto">
    <input type="text" id="url_imagen" placeholder="url de imagen" required>
    <input type="text" id="nombre" placeholder="Nombre del producto" required>
    <textarea id="descripcion" placeholder="Descripción del producto" required></textarea>
    <input type="number" id="precio" placeholder="Precio" required>
    <label for="categoria">Categoría:</label>
    <select id="categoria" required>
    <option value="" disabled selected>Selecciona una Categoría</option>
    <option value="bebidas">Bebidas</option>
    <option value="snack">Snacks</option>
    <option value="dulces">Dulce</option> 
    <option value="panaderia">Panaderia</option> 
    </select>
    <input type="checkbox" id="alcoholicas">alcohol
    <input type="checkbox" id="conTacc">contacc
    <button type="submit" id="guardar">Guardar</button>
  </form>

  <div id="modalEdicion" class="modal">
    <div class="modal-contenido">
        <h2>Editar Producto</h2>
        
        <form id="formEdicion">
            <input type="hidden" id="edit-id"> 
            
            <label for="edit-nombre">Nombre:</label>
            <input type="text" id="edit-nombre" required>
            
            <label for="edit-descripcion">Descripción:</label>
            <textarea id="edit-descripcion" required></textarea>
            
            <label for="edit-precio">Precio:</label>
            <input type="number" id="edit-precio" step="0.01" required>

            <label for="edit-categoria">Categoría:</label>
            <select id="edit-categoria" required>
                <option value="snack">Snack</option>
                <option value="bebidas">Bebida</option>
                <option value="panaderia">Panaderia</option>
                <option value="dulces">dulces</option>
                </select>
            
            <label for="edit-url_imagen">URL Imagen:</label>
            <input type="text" id="edit-url_imagen">

            <div style="margin: 1rem 0;">
                <input type="checkbox" id="edit-conTacc">
                <label for="edit-conTacc">Contiene TACC</label>
            </div>
            <div style="margin: 1rem 0;">
                <input type="checkbox" id="edit-alcoholicas">
                <label for="edit-alcoholicas">Es Alcohólica</label>
            </div>

            <div class="modal-botones">
                <button type="submit" id="btnActualizar">Actualizar</button>
                <button type="button" onclick="cerrarModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

  <!-- Tabla de productos -->
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Producto</th> <!-- cambiado -->
        <th>Descripción</th>
        <th>Precio</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tabla-body">
    </tbody>
  </table>

  <script>
    const API_URL = "http://localhost:8080/productos"; // RUTA DE TU API DE SPRING BOOT

// =================================================================
// FUNCIÓN 1: OBTENER TODOS LOS PRODUCTOS (GET)
// =================================================================
async function obtenerProductos() {
    try {
        const resp = await fetch(API_URL);
        if (!resp.ok) {
            // Si la respuesta no es 2xx (por ejemplo, 404 o 500)
            throw new Error(`Error en la solicitud GET: ${resp.status} ${resp.statusText}`);
        }
        const productos = await resp.json();
        return productos;
    } catch (error) {
        console.error('Fallo al obtener la lista de productos. CORS o API no disponible:', error.message);
        return null; // Devuelve null si hay un fallo
    }
}

// =================================================================
// FUNCIÓN 2: CREAR UN PRODUCTO (POST)
// (Usando el nombre de función que proporcionaste: crearProductos)
// =================================================================
async function crearProductos(producto) {
    try {
        const respuesta = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify(producto) 
        });

        if (!respuesta.ok) {
            const errorData = await respuesta.text(); 
            console.error('Error al crear el producto. Detalles de la API:', errorData);
            throw new Error(`Error en la creación: ${respuesta.status}`);
        }

        const productoCreado = await respuesta.json();
        console.log('Producto creado exitosamente:', productoCreado);
        return productoCreado;

    } catch (error) {
        console.error('Fallo en la conexión o proceso de creación:', error.message);
        return null;
    }
}

// =================================================================
// FUNCIÓN 3: RENDERIZAR LA TABLA (Muestra los productos en el panel admin)
// =================================================================
async function renderTabla() {
    const productos = await obtenerProductos(); 

    const tabla = document.getElementById("tabla-body");
    tabla.innerHTML = "";
    
    if (!productos || productos.length === 0) {
        tabla.innerHTML = '<tr><td colspan="5">No hay productos registrados o hubo un error al cargar.</td></tr>';
        return;
    }

    productos.forEach(prod => {
        tabla.innerHTML += `
            <tr>
                <td>${prod.id}</td>
                <td>${prod.nombre}</td>
                <td>${prod.descripcion}</td>
                <td>$${parseFloat(prod.precio).toFixed(2)}</td>
                <td>
                    <button class="editar" onclick="editar(${prod.id})">Editar</button>
                    <button class="eliminar" onclick="eliminar(${prod.id})">Eliminar</button>
                </td>
            </tr>
        `;
    });
}


// =================================================================
// FUNCIÓN 4: CREAR TARJETA DE PRODUCTO (para la vista del cliente)
// =================================================================
function crearTarjetaProducto(producto) {
    // Usamos 'imagenUrl' si existe, sino 'imagen', sino vacío.
    const imagenSrc = producto.imagenUrl || producto.imagen || ''; 
    const precioFijo = parseFloat(producto.precio).toFixed(2);
    
    const tarjeta = document.createElement('div');
    tarjeta.classList.add('producto-card');
    tarjeta.setAttribute('data-id', producto.id);

    tarjeta.innerHTML = `
        <img 
            src="${imagenSrc}" 
            alt="${producto.nombre}" 
            onerror="this.src='https://via.placeholder.com/250x150?text=Imagen+no+disponible'" 
        />
        <div class="contenido">
            <h3>${producto.nombre}</h3>
            <p>${producto.descripcion}</p>
            <div class="precio">$${precioFijo}</div>
            <div class="likes">${producto.likes || 0} likes</div> 
            
            <button class="btn-agregar" onclick="agregarAlCarrito(${producto.id})">
                Agregar al Carrito
            </button>
        </div>
    `;

    return tarjeta;
}


// =================================================================
// FUNCIÓN 5: CARGAR PRODUCTOS EN VISTA DE CLIENTE
// =================================================================
async function cargarProductosCliente() {
    const contenedor = document.getElementById('productos-container');
    
    // Si el contenedor no existe (estás solo en la vista de administrador), no hagas nada.
    if (!contenedor) return; 

    contenedor.innerHTML = 'Cargando productos...'; 

    const productos = await obtenerProductos(); 

    contenedor.innerHTML = ''; 

    if (productos && productos.length > 0) {
        productos.forEach(producto => {
            const tarjetaElemento = crearTarjetaProducto(producto);
            contenedor.appendChild(tarjetaElemento);
        });
    } else {
        contenedor.innerHTML = '<p>Lo sentimos, no hay productos disponibles en este momento.</p>';
    }
}


// =================================================================
// MANEJO DEL FORMULARIO: CREACIÓN DE PRODUCTOS
// =================================================================
document.getElementById("formProducto").addEventListener("submit", async e => {
    e.preventDefault();
    
    // Recoge todos los nuevos campos, incluyendo los checkboxes
    let producto = {
        nombre: document.getElementById("nombre").value,
        descripcion: document.getElementById("descripcion").value,
        precio: parseFloat(document.getElementById("precio").value),
        // IMPORTANTE: Asegúrate que tu Enum de Java acepte minúsculas o cambia esto a .toUpperCase()
        categoria: document.getElementById("categoria").value, 
        imagenUrl: document.getElementById("url_imagen").value,
        conTacc: document.getElementById("conTacc").checked,
        alcoholicas: document.getElementById("alcoholicas").checked
    };

    const resultado = await crearProductos(producto);

    if (resultado) {
        alert(`✅ Producto '${resultado.nombre}' guardado.`);
    } else {
        alert("❌ Hubo un error al guardar el producto. Revisa la consola.");
    }
    
    // Recargar ambas vistas
    renderTabla();
    cargarProductosCliente(); 
    e.target.reset();
});

// =================================================================
// FUNCIONES AUXILIARES: ELIMINAR Y EDITAR
// =================================================================

// Eliminar producto (DELETE)
async function eliminar(id) {
    if (confirm(`¿Estás seguro de que quieres eliminar el producto con ID ${id}?`)) {
        try {
            const resp = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
            if (!resp.ok) {
                throw new Error(`Error en la solicitud DELETE: ${resp.status}`);
            }
            alert(`Producto con ID ${id} eliminado.`);
            renderTabla();
            cargarProductosCliente();
        } catch (error) {
            console.error('Fallo al eliminar:', error.message);
            alert("Error al eliminar el producto. Revisa la consola.");
        }
    }
}

// Editar producto (Cargar datos para edición)
async function editar(id) {
    try {
        const resp = await fetch(`${API_URL}/${id}`);
        if (!resp.ok) {
            throw new Error(`Error al obtener producto para editar: ${resp.status}`);
        }
        const prod = await resp.json();

        // 1. Cargar datos en el modal
        document.getElementById("edit-id").value = prod.id;
        document.getElementById("edit-nombre").value = prod.nombre;
        document.getElementById("edit-descripcion").value = prod.descripcion;
        document.getElementById("edit-precio").value = prod.precio;
        
        // Asegúrate de que el valor del Enum coincida con una <option>
        document.getElementById("edit-categoria").value = prod.categoria; 

        // Manejo de valores que podrían ser null o undefined
        document.getElementById("edit-url_imagen").value = prod.imagenUrl || prod.imagen || '';
        document.getElementById("edit-conTacc").checked = prod.conTacc || false;
        document.getElementById("edit-alcoholicas").checked = prod.alcoholicas || false;

        // 2. Mostrar el modal
        document.getElementById("modalEdicion").style.display = "block";

    } catch (error) {
        console.error('Fallo al cargar datos para edición:', error.message);
        alert("Error al cargar datos. Revisa la consola.");
    }
}

// =================================================================
// NUEVA FUNCIÓN: CERRAR MODAL
// =================================================================
function cerrarModal() {
    document.getElementById("modalEdicion").style.display = "none";
}

// =================================================================
// NUEVA FUNCIÓN: ACTUALIZAR PRODUCTO (PUT)
// =================================================================
async function actualizarProducto(id, producto) {
    try {
        const respuesta = await fetch(`${API_URL}/${id}`, {
            method: 'PUT', // Método HTTP para actualización
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(producto)
        });

        if (!respuesta.ok) {
            const errorData = await respuesta.text();
            console.error('Error al actualizar el producto. Detalles:', errorData);
            throw new Error(`Error en la actualización: ${respuesta.status}`);
        }

        const productoActualizado = await respuesta.json();
        console.log('Producto actualizado exitosamente:', productoActualizado);
        return productoActualizado;

    } catch (error) {
        console.error('Fallo en la conexión o proceso de actualización:', error.message);
        return null;
    }
}


// =================================================================
// MANEJO DEL FORMULARIO DE EDICIÓN
// =================================================================
document.getElementById("formEdicion").addEventListener("submit", async e => {
    e.preventDefault();
    
    // 1. Recoger los datos del modal
    const id = document.getElementById("edit-id").value;
    const productoActualizado = {
        nombre: document.getElementById("edit-nombre").value,
        descripcion: document.getElementById("edit-descripcion").value,
        precio: parseFloat(document.getElementById("edit-precio").value),
        categoria: document.getElementById("edit-categoria").value,
        imagenUrl: document.getElementById("edit-url_imagen").value,
        conTacc: document.getElementById("edit-conTacc").checked,
        alcoholicas: document.getElementById("edit-alcoholicas").checked
    };

    // 2. Llamar a la función de actualización
    const resultado = await actualizarProducto(id, productoActualizado);

    if (resultado) {
        alert(`✅ Producto '${resultado.nombre}' actualizado.`);
        cerrarModal(); // Cerrar el modal al finalizar
    } else {
        alert("❌ Hubo un error al actualizar el producto. Revisa la consola.");
    }
    
    // 3. Recargar las tablas para reflejar los cambios
    renderTabla();
    cargarProductosCliente(); 
});


// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', () => {
    renderTabla(); // Carga la vista de administración
    cargarProductosCliente(); // Carga la vista de cliente (si el contenedor existe)
});
  </script>

</body>
</html>